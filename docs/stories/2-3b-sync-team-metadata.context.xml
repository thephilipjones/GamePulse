<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3b</storyId>
    <title>Sync Team Metadata from NCAA API</title>
    <status>drafted</status>
    <generatedAt>2025-11-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-3b-sync-team-metadata.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>data engineer</asA>
    <iWant>to automatically discover and sync team metadata from NCAA API game responses</iWant>
    <soThat>GamePulse can track all teams that play games without requiring manual seed data updates for every team</soThat>
    <tasks>
      <task id="1" title="Add espn_team_id to DimTeam Model">
        <files>
          <file>backend/app/models/dim_team.py</file>
        </files>
        <description>Add espn_team_id field to DimTeam SQLModel (refactored in Story 2-3a), create Alembic migration to add column with index and backfill existing rows by extracting from team_id</description>
      </task>

      <task id="2" title="Create Team Sync Service">
        <files>
          <file>backend/app/services/team_sync.py (NEW)</file>
        </files>
        <description>Implement sync_teams_from_games() with batch PostgreSQL upsert using ON CONFLICT on team_id (natural key), NOT team_key (surrogate key). Preserve manually curated fields.</description>
      </task>

      <task id="3" title="Integrate with NCAA Games Dagster Asset">
        <files>
          <file>backend/app/assets/ncaa_games.py</file>
        </files>
        <description>Reference implementation pattern for Story 2-4. Team sync called before game processing to ensure foreign keys exist</description>
        <note>Story 2-4 implements full Dagster asset. This task documents integration pattern.</note>
      </task>

      <task id="4" title="Update Seed Data Migration for Idempotency">
        <files>
          <file>backend/app/alembic/versions/7a8f23177a57_seed_dimensional_data.py</file>
        </files>
        <description>Update seed migration to use dim_team schema, include espn_team_id in upsert, extract ESPN ID from team_id. Already schema-aware from Story 2-3a.</description>
      </task>

      <task id="5" title="Add Comprehensive Tests">
        <files>
          <file>backend/app/tests/services/test_team_sync.py (NEW)</file>
          <file>backend/app/tests/models/test_dim_team.py (UPDATE)</file>
        </files>
        <description>Unit and integration tests: team discovery, surrogate key preservation, merge logic, batch upsert efficiency, edge cases</description>
      </task>

      <task id="6" title="Create Documentation">
        <files>
          <file>backend/app/data/README.md (NEW)</file>
          <file>docs/stories/future-enhancements.md (EXISTS)</file>
        </files>
        <description>Document hybrid strategy, merge logic, manual override process. future-enhancements.md already created with Story 2-3b draft.</description>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="AC1" title="Team Discovery from API Game Responses">
      <given>NCAA client has fetched today's games from scoreboard API</given>
      <when>processing the game response data</when>
      <then>
        - Extract unique teams from home/away fields
        - Create records in dim_team with:
          * team_id: "ncaam_{espn_team_id}" (natural key)
          * team_key: Auto-generated SERIAL surrogate key (DB handles)
          * espn_team_id: Raw ESPN ID from API
          * team_name: Use names.short from API
          * sport: "ncaam"
          * is_current: TRUE (SCD Type 2 from Story 2-3a)
          * valid_from: NOW()
        - Leave team_abbr, colors, aliases, team_group_* as NULL
      </then>
      <validation>
        - Query after sync, verify new teams exist with correct natural key
        - Verify team_key auto-generated (not NULL, unique)
        - Verify espn_team_id matches API
        - Verify is_current=TRUE and valid_from set
      </validation>
    </ac>

    <ac id="AC2" title="Idempotent Merge Strategy">
      <given>Team already exists in database (seed or previous sync)</given>
      <when>syncing teams from API</when>
      <then>
        - Use ON CONFLICT (team_id) DO UPDATE (natural key, NOT team_key)
        - UPDATE only: team_name, espn_team_id (if NULL), updated_at
        - PRESERVE: team_key (surrogate immutable), colors, aliases, team_group_*, team_abbr, SCD fields
      </then>
      <validation>
        - Seed Duke with colors/aliases
        - Sync from API
        - Verify team_key unchanged (same surrogate value)
        - Verify colors/aliases preserved
        - Verify team_name updated if API differs
      </validation>
    </ac>

    <ac id="AC3" title="Logging and Observability">
      <given>Teams being synced from API</given>
      <when>sync completes</when>
      <then>
        - Log INFO for new teams: "Team discovered: {team_id} ({team_name}) - ESPN ID {espn_team_id}"
        - Log DEBUG for updates: "Team updated: {team_id} - name '{old}' → '{new}'"
        - Return metadata: {teams_discovered, teams_updated, teams_unchanged}
        - Dagster integration (Story 2-4) includes counts in materialization metadata
      </then>
      <validation>
        - Run sync with mix of new/existing teams
        - Check logs for discovery/update messages
        - Verify metadata counts match DB changes
      </validation>
    </ac>

    <ac id="AC4" title="Graceful Handling of Missing Teams">
      <given>Game references team not in database</given>
      <when>polling worker attempts game insert</when>
      <then>
        - Create minimal team record before game insert
        - Log WARNING: "Team {team_id} auto-created - consider adding colors/aliases in teams.json"
        - Continue processing remaining games (don't fail batch)
        - Return success with warning count
      </then>
      <validation>
        - Process game with ncaam_999 (not in seed)
        - Verify team created with NULL colors/aliases
        - Verify warning logged
        - Verify game inserted with FK to new team
      </validation>
    </ac>

    <ac id="AC5" title="Migration for espn_team_id Column">
      <given>dim_team table exists from Story 2-3a</given>
      <when>running new Alembic migration</when>
      <then>
        - Add column: espn_team_id VARCHAR NULL
        - Add index on espn_team_id
        - Backfill: extract from team_id ("ncaam_150" → "150")
        - Row count unchanged
        - Migration reversible
      </then>
      <validation>
        - Run upgrade, verify column exists
        - Verify existing teams have espn_team_id
        - Verify team_key (surrogate PK) unchanged
        - Run downgrade, verify column removed
        - Run upgrade again (idempotent)
      </validation>
    </ac>

    <ac id="AC6" title="Documentation and Future Work Tracker">
      <given>Story 2-3b complete</given>
      <when>developers/agents need to understand team sync</when>
      <then>
        - backend/app/data/README.md: seed strategy, merge logic, manual override instructions
        - docs/stories/future-enhancements.md: colors automation, aliases generation, conference automation
      </then>
      <validation>
        - Files exist at specified paths
        - Documentation clear and actionable
        - Future work tracked with effort estimates
      </validation>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-1.2: Team and Conference Dimensional Data</section>
        <snippet>System SHALL maintain dimensional data for NCAA teams. MVP requires minimum 20 top teams with names, colors, conference IDs, and aliases. Story 2-3b extends this to auto-discover all 350+ Division I teams.</snippet>
      </doc>

      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Dimensional Data as JSON Config</section>
        <snippet>Dimensional data (teams, conferences) loaded from JSON via Alembic migration. Story 2-3b extends to hybrid: seed foundation + API auto-discovery.</snippet>
      </doc>

      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Data Flow Architecture</section>
        <snippet>Epic 2 flow: NCAA API → Client → Parse → Transform → Database. Story 2-3b inserts team sync BEFORE game insert to ensure FKs exist. Dagster triggers every 15 minutes.</snippet>
      </doc>

      <doc>
        <path>docs/stories/2-3a-refactor-dimensional-model.md</path>
        <title>Story 2-3a: Refactor to Dimensional Model (PREREQUISITE - COMPLETE)</title>
        <section>Context and Learnings</section>
        <snippet>Refactored teams → dim_team with surrogate keys (team_key SERIAL PK, team_id natural key). Flattened team_group. Added SCD Type 2 fields. ALL tests pass. Story 2-3b uses this new dim_team schema with team_key as immutable surrogate PK.</snippet>
      </doc>

      <doc>
        <path>docs/stories/future-enhancements.md</path>
        <title>Future Enhancements</title>
        <section>Dimensional Data Enhancements</section>
        <snippet>Documents future work: team colors automation (3-7h), aliases generation (6-10h), conference automation (8-12h). Prioritized for Epic 4+ planning.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>backend/app/models/dim_team.py</path>
        <kind>SQLModel</kind>
        <symbol>DimTeam</symbol>
        <lines>1-60</lines>
        <reason>Current dimensional team model from Story 2-3a. Has team_key (surrogate PK), team_id (natural key), SCD Type 2 fields. Need to add espn_team_id field.</reason>
      </artifact>

      <artifact>
        <path>backend/app/models/fact_game.py</path>
        <kind>SQLModel</kind>
        <symbol>FactGame</symbol>
        <lines>1-70</lines>
        <reason>Game model with FKs to dim_team via team_key (surrogate). Team sync ensures FKs satisfied before game insert.</reason>
      </artifact>

      <artifact>
        <path>backend/app/services/ncaa_client.py</path>
        <kind>Service</kind>
        <symbol>NCAAClient</symbol>
        <lines>1-150</lines>
        <reason>Fetches games from NCAA API. Returns list of game dicts with home/away team data. Team sync extracts teams from this response.</reason>
      </artifact>

      <artifact>
        <path>backend/app/alembic/versions/7a8f23177a57_seed_dimensional_data.py</path>
        <kind>Migration</kind>
        <symbol>upgrade</symbol>
        <lines>23-95</lines>
        <reason>Seed data migration with ON CONFLICT upsert pattern. Schema-aware (handles both old teams and new dim_team). Need to add espn_team_id to upsert.</reason>
      </artifact>

      <artifact>
        <path>backend/app/alembic/versions/d115685a3652_refactor_to_dimensional_model_with_.py</path>
        <kind>Migration</kind>
        <symbol>upgrade</symbol>
        <lines>1-247</lines>
        <reason>Story 2-3a migration that created dim_team with surrogate keys. Provides pattern for new espn_team_id migration (add column, index, backfill).</reason>
      </artifact>

      <artifact>
        <path>backend/app/data/teams.json</path>
        <kind>Data</kind>
        <symbol>N/A</symbol>
        <lines>1-200</lines>
        <reason>Seed data with 20 top teams including colors, aliases, team_group_id. Manual curation foundation. Format: team_id "ncaam_150" contains ESPN ID.</reason>
      </artifact>

      <artifact>
        <path>backend/app/tests/models/test_dim_team.py</path>
        <kind>Test</kind>
        <symbol>test_create_dim_team</symbol>
        <lines>1-150</lines>
        <reason>Existing tests for DimTeam model. Need to add test for espn_team_id field.</reason>
      </artifact>
    </code>

    <dependencies>
      <python>
        <package>sqlmodel</package>
        <version>^0.0.22</version>
        <usage>ORM for dim_team model and upsert queries</usage>
      </python>

      <python>
        <package>sqlalchemy</package>
        <version>^2.0</version>
        <usage>PostgreSQL dialect for ON CONFLICT upsert (sqlalchemy.dialects.postgresql)</usage>
      </python>

      <python>
        <package>alembic</package>
        <version>^1.13</version>
        <usage>Database migrations for espn_team_id column</usage>
      </python>

      <python>
        <package>pydantic</package>
        <version>^2.0</version>
        <usage>Type validation for team data structures</usage>
      </python>

      <python>
        <package>pytest</package>
        <version>^8.0</version>
        <usage>Test framework for team_sync tests</usage>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural">
      Use dim_team schema from Story 2-3a with surrogate keys. team_key is surrogate PK (auto-generated, immutable). team_id is natural key (unique constraint). Upsert on team_id, NEVER update team_key.
    </constraint>

    <constraint type="data-preservation">
      Manually curated fields (colors, aliases, team_group_id, team_abbr) MUST be preserved during API sync. Use ON CONFLICT DO UPDATE with explicit field list excluding these fields.
    </constraint>

    <constraint type="performance">
      Use batch upsert (single PostgreSQL query) for all teams. No N+1 queries. Typical scoreboard has ~40 teams (20 games).
    </constraint>

    <constraint type="scd-type-2">
      SCD Type 2 fields (is_current, valid_from, valid_to) present from Story 2-3a but NOT used in Story 2-3b. Story 11.1 will implement SCD logic. Do NOT update these during sync.
    </constraint>

    <constraint type="testing">
      All new code must have >80% test coverage. Migration must be tested with upgrade/downgrade/idempotent cycles. Integration tests with real database required.
    </constraint>

    <constraint type="logging">
      Use Python logging module (not print). INFO for discoveries, DEBUG for updates, WARNING for auto-created teams needing manual follow-up.
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>sync_teams_from_games</name>
      <kind>Python async function</kind>
      <signature>
async def sync_teams_from_games(
    games_data: list[dict],
    session: Session
) -> dict[str, int]
      </signature>
      <path>backend/app/services/team_sync.py (NEW)</path>
      <description>
        Extracts teams from NCAA API game responses and syncs to dim_team table.
        Returns metadata: {teams_discovered: int, teams_updated: int, teams_unchanged: int}
      </description>
    </interface>

    <interface>
      <name>NCAA API Scoreboard</name>
      <kind>REST endpoint</kind>
      <signature>GET https://ncaa-api.henrygd.me/scoreboard/basketball-men/d1?date=YYYYMMDD</signature>
      <path>External API</path>
      <description>
        Returns games with team data: {home: {id, names: {short, full, abbrev}}, away: {...}}
        NO conference, colors, or logos in response. names.short preferred for team_name.
      </description>
    </interface>

    <interface>
      <name>DimTeam SQLModel</name>
      <kind>Database model</kind>
      <signature>
class DimTeam(SQLModel, table=True):
    team_key: int  # Surrogate PK (SERIAL, auto-generated)
    team_id: str   # Natural key (UNIQUE)
    espn_team_id: str | None  # NEW in Story 2-3b
    # ... other fields
      </signature>
      <path>backend/app/models/dim_team.py</path>
      <description>Dimensional team model with surrogate keys from Story 2-3a. Need to add espn_team_id field.</description>
    </interface>

    <interface>
      <name>PostgreSQL ON CONFLICT Upsert</name>
      <kind>SQL pattern</kind>
      <signature>
INSERT INTO dim_team (...) VALUES (...)
ON CONFLICT (team_id) DO UPDATE SET
    team_name = EXCLUDED.team_name,
    espn_team_id = EXCLUDED.espn_team_id,
    updated_at = EXCLUDED.updated_at
    -- NOT team_key (immutable surrogate)
    -- NOT colors, aliases, team_group_* (preserved)
      </signature>
      <path>PostgreSQL dialect via SQLAlchemy</path>
      <description>Idempotent upsert pattern. Conflict on natural key (team_id), preserve manual curation.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      GamePulse uses pytest for backend testing with SQLModel test fixtures. Tests follow TDD pattern: write tests first, implement to pass. Integration tests use real PostgreSQL test database (Docker Compose service). Type checking with mypy, linting with ruff. Pre-commit hooks enforce quality gates.
    </standards>

    <locations>
      - backend/app/tests/services/test_team_sync.py (NEW - unit and integration tests for team sync service)
      - backend/app/tests/models/test_dim_team.py (UPDATE - add test for espn_team_id field)
      - backend/app/tests/migrations/ (migration tests if needed)
    </locations>

    <ideas>
      <idea ac="AC1">
        test_discover_new_team: Mock games with new team, verify inserted with auto-generated team_key, correct espn_team_id, NULL colors/aliases
      </idea>

      <idea ac="AC2">
        test_preserve_manual_data: Seed Duke with colors/aliases and specific team_key, sync from API with different name, verify team_key unchanged, colors preserved, name updated
      </idea>

      <idea ac="AC2">
        test_upsert_preserves_surrogate_key: Create team with team_key=100, sync same team_id, verify team_key still 100 (immutable)
      </idea>

      <idea ac="AC3">
        test_metadata_counts: Mix of 5 new teams, 2 updates, 3 unchanged. Verify metadata: {discovered: 5, updated: 2, unchanged: 3}
      </idea>

      <idea ac="AC3">
        test_logging_output: Capture logs, verify INFO for discoveries, DEBUG for updates, correct formatting
      </idea>

      <idea ac="AC4">
        test_missing_team_graceful: Process game with unknown team, verify minimal team created, warning logged, game insert succeeds
      </idea>

      <idea ac="AC5">
        test_migration_backfill: Run migration, verify espn_team_id extracted from team_id for existing rows, verify team_key unchanged
      </idea>

      <idea ac="AC5">
        test_migration_idempotent: Run upgrade → verify → downgrade → verify → upgrade again → verify (no data loss)
      </idea>

      <idea ac="edge-case">
        test_empty_games_list: sync_teams_from_games with [], verify {discovered: 0, updated: 0, unchanged: 0}, no errors
      </idea>

      <idea ac="edge-case">
        test_duplicate_teams_in_response: Games with same team appearing multiple times, verify deduplicated (single insert)
      </idea>

      <idea ac="edge-case">
        test_null_team_name: Game with missing names.short, verify graceful handling (skip or use names.full fallback)
      </idea>

      <idea ac="edge-case">
        test_batch_upsert_efficiency: Benchmark 200 teams, verify single query execution (check query logs or session.exec call count)
      </idea>

      <idea ac="integration">
        test_seed_migration_after_sync: Auto-discover team, run seed migration, verify auto-discovered team preserved with same team_key
      </idea>
    </ideas>
  </tests>
</story-context>
